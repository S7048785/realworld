# 路由切换过渡动画实现原理

## 概述

本项目使用 **React Router v7** + **Framer Motion (motion/react)** 实现页面切换时的平滑过渡动画。

## 核心组件：`AnimatedOutlet`

### 代码实现

```tsx
// src/components/AnimatedOutlet.tsx
import {useLocation, useOutlet} from "react-router-dom";
import { motion, AnimatePresence } from "motion/react";

function AnimatedOutlet() {
  const location = useLocation();
  const outlet = useOutlet();

  return (
    <div className="relative">
      <AnimatePresence mode="wait">
        <motion.div
          key={location.pathname}
          initial={{ y: 2, opacity: 0, filter : "blur(2px)" }}
          animate={{ y: 0, opacity: 1, filter : "blur(0px)" }}
          exit={{ y: 2, opacity: 0, filter : "blur(2px)" }}
          className="absolute inset-0 w-full "
        >
          {outlet}
        </motion.div>
      </AnimatePresence>
    </div>
  );
}

export default AnimatedOutlet;
```

### 在根组件中使用

```tsx
// src/App.tsx
import AnimatedOutlet from "@/components/AnimatedOutlet";

function App() {
  return (
    <>
      <NavBar />
      <AnimatedOutlet />
    </>
  );
}
```

---

## 实现原理

### 1. `useOutlet()` - 获取当前路由组件

```tsx
const outlet = useOutlet();
```

`useOutlet()` 是 React Router 提供的 Hook，用于获取当前路由匹配的组件并渲染它。这使得我们可以在组件外部包装动画逻辑。

### 2. `useLocation()` - 监听路由变化

```tsx
const location = useLocation();
```

`useLocation()` 返回当前路由的位置对象，包含 `pathname` 等属性。每次路由切换时，`location.pathname` 会发生变化。

### 3. `key` 属性触发重新渲染

```tsx
<motion.div key={location.pathname}>
```

**这是动画触发的关键**：

- 当 `key` 从 `/home` 变为 `/about` 时，React 识别为不同的元素
- Framer Motion 检测到 `key` 变化，会触发旧元素的 `exit` 动画和新元素的 `initial` → `animate` 动画

### 4. `AnimatePresence` - 管理退出动画

```tsx
<AnimatePresence mode="wait">
```

- **作用**：包裹需要动画的元素，使其在卸载前执行 `exit` 动画
- **`mode="wait"`**：确保**旧页面完全退出后才开始新页面的进入动画**（先退后进）
- 如果设为 `"pop"`（默认），则新页面会立即进入，与旧页面同时存在

### 5. CSS 定位策略

```tsx
<div className="relative">       // 父容器：相对定位
  <motion.div className="absolute inset-0 w-full">  // 子元素：绝对定位
```

使用绝对定位让新旧页面在同一位置叠加显示，确保动画期间不会出现页面跳动。

---

## 动画效果详解

| 状态                | 属性                            | 视觉效果             |
|-------------------|-------------------------------|------------------|
| **initial** (进入前) | `y: 2, opacity: 0, blur(2px)` | 从下方 2px 开始、透明、模糊 |
| **animate** (进入后) | `y: 0, opacity: 1, blur(0px)` | 滑入到正常位置、清晰显示     |
| **exit** (退出时)    | `y: 2, opacity: 0, blur(2px)` | 向下淡出、模糊          |

这种 **blur + translate + fade** 的组合创造出现代感的页面切换效果。

---

## 动画执行流程

```
用户点击链接 → 路由切换
        ↓
location.pathname 变化
        ↓
AnimatePresence 检测到 key 变化
        ↓
┌─────────────────────────────────┐
│  旧页面：执行 exit 动画          │
│  - blur(0px) → blur(2px)        │
│  - opacity: 1 → 0               │
│  - y: 0 → 2                     │
└─────────────────────────────────┘
        ↓ (等待 exit 完成)
┌─────────────────────────────────┐
│  新页面：执行 enter 动画         │
│  - initial: blur(2px), opacity:0│
│  - animate: blur(0px), opacity:1│
│  - y: 2 → 0                     │
└─────────────────────────────────┘
        ↓
动画完成，新页面正常显示
```

---

## 为什么这种实现方式优雅？

1. **声明式动画** - 所有动画配置都在同一个组件中，无需在每个页面单独添加
2. **自动继承** - 所有子路由自动获得过渡动画，无需额外配置
3. **性能优化** - 使用 `mode="wait"` 确保动画期间不会有大量 DOM 操作
4. **可复用** - `AnimatedOutlet` 是一个独立的组件，可在任何项目中使用

---

## 扩展：自定义动画效果

### 不同的过渡模式

```tsx
// 左右滑动效果
<motion.div
  key={location.pathname}
  initial={{ x: 20, opacity: 0 }}
  animate={{ x: 0, opacity: 1 }}
  exit={{ x: -20, opacity: 0 }}
  transition={{ duration: 0.3 }}
>

// 缩放效果
<motion.div
  key={location.pathname}
  initial={{ scale: 0.9, opacity: 0 }}
  animate={{ scale: 1, opacity: 1 }}
  exit={{ scale: 0.9, opacity: 0 }}
>

// 翻转效果
<motion.div
  key={location.pathname}
  initial={{ rotateY: 90, opacity: 0 }}
  animate={{ rotateY: 0, opacity: 1 }}
  exit={{ rotateY: -90, opacity: 0 }}
>
```

### 不同页面不同动画

```tsx
// 基于路由名称切换动画类型
const getAnimation = (pathname: string) => {
  if (pathname.startsWith('/article')) {
    return { initial: { x: 50 }, animate: { x: 0 }, exit: { x: -50 } };
  }
  return { initial: { y: 10 }, animate: { y: 0 }, exit: { y: -10 } };
};

// 使用
const anim = getAnimation(location.pathname);
<motion.div
  key={location.pathname}
  initial={anim.initial}
  animate={anim.animate}
  exit={anim.exit}
>
```

---

## 注意事项

1. **绝对定位的副作用**：由于使用 `absolute`，页面容器高度可能为 0，需要在父容器上设置合适的高度

2. **动画时长匹配**：确保 `exit` 动画完成后再移除 DOM，Framer Motion
   会自动处理，但如果页面有复杂异步操作，可能需要调整 `transition` 参数

3. **性能考虑**：对于复杂页面，过渡动画可能造成性能压力，可通过 `will-change` 或降低动画复杂度来优化
